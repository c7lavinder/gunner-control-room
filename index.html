<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gunner Control Room</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0e17;--card:#131a2b;--card-hover:#1a2340;--border:#1e2a45;--text:#e2e8f0;--text-dim:#64748b;--green:#22c55e;--yellow:#eab308;--red:#ef4444;--blue:#3b82f6;--purple:#a855f7;--accent:#3b82f6;--panel-bg:#0f1525}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:radial-gradient(ellipse at 20% 50%,rgba(59,130,246,0.08) 0%,transparent 50%),radial-gradient(ellipse at 80% 20%,rgba(168,85,247,0.06) 0%,transparent 50%),radial-gradient(ellipse at 50% 80%,rgba(34,197,94,0.05) 0%,transparent 50%);pointer-events:none;z-index:0}

.header{position:sticky;top:0;z-index:100;background:rgba(10,14,23,0.85);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:16px 24px}
.header-inner{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.logo-area{display:flex;align-items:center;gap:14px}
.logo-icon{width:44px;height:44px;background:linear-gradient(135deg,var(--blue),var(--purple));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 0 20px rgba(59,130,246,0.3)}
.logo-text h1{font-size:22px;font-weight:700;background:linear-gradient(135deg,#e2e8f0,#94a3b8);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo-text p{font-size:12px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase}
.header-right{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.connection-badge{display:flex;align-items:center;gap:6px;padding:6px 14px;background:var(--card);border:1px solid var(--border);border-radius:8px;font-size:12px;font-weight:600;transition:all 0.3s}
.connection-badge.connected{border-color:rgba(34,197,94,0.3);color:var(--green)}
.connection-badge.disconnected{border-color:rgba(239,68,68,0.3);color:var(--red)}
.stats-bar{display:flex;gap:20px;flex-wrap:wrap}
.stat{display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--card);border:1px solid var(--border);border-radius:10px}
.stat .dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.stat .dot.green{background:var(--green);box-shadow:0 0 8px var(--green)}
.stat .dot.yellow{background:var(--yellow);box-shadow:0 0 8px var(--yellow)}
.stat .dot.red{background:var(--red);box-shadow:0 0 8px var(--red)}
.stat .num{font-size:18px;font-weight:700}
.stat .label{font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px}

.main{max-width:1400px;margin:0 auto;padding:24px;position:relative;z-index:1}

.engine{margin-bottom:32px}
.engine-header{display:flex;align-items:center;gap:12px;margin-bottom:16px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.engine-badge{padding:4px 12px;border-radius:6px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px}
.engine-badge.live{background:rgba(34,197,94,0.15);color:var(--green);border:1px solid rgba(34,197,94,0.3)}
.engine-badge.built{background:rgba(59,130,246,0.15);color:var(--blue);border:1px solid rgba(59,130,246,0.3)}
.engine-badge.planned{background:rgba(234,179,8,0.15);color:var(--yellow);border:1px solid rgba(234,179,8,0.3)}
.engine-badge.online{background:rgba(34,197,94,0.15);color:var(--green);border:1px solid rgba(34,197,94,0.3)}
.engine-badge.idle{background:rgba(234,179,8,0.15);color:var(--yellow);border:1px solid rgba(234,179,8,0.3)}
.engine-badge.offline{background:rgba(239,68,68,0.15);color:var(--red);border:1px solid rgba(239,68,68,0.3)}
.engine-title{font-size:16px;font-weight:600;color:var(--text)}
.engine-subtitle{font-size:13px;color:var(--text-dim)}

.desk-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}

.desk{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;cursor:pointer;transition:all 0.25s ease;position:relative;overflow:hidden}
.desk:hover{background:var(--card-hover);border-color:rgba(59,130,246,0.3);transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,0.3)}
.desk::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:14px 14px 0 0;opacity:0;transition:opacity 0.25s}
.desk:hover::before{opacity:1}
.desk.status-online::before{background:linear-gradient(90deg,var(--green),var(--blue))}
.desk.status-idle::before{background:linear-gradient(90deg,var(--yellow),#f97316)}
.desk.status-standby::before{background:linear-gradient(90deg,var(--yellow),#f97316)}
.desk.status-dry-run::before{background:linear-gradient(90deg,#f97316,#f59e0b)}
.desk.status-offline::before{background:linear-gradient(90deg,var(--red),#dc2626)}
.engine-badge.dryrun{background:linear-gradient(90deg,#f97316,#f59e0b);color:#000}
.desk-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:14px}
.bot-avatar{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;position:relative}
.bot-avatar.online{background:rgba(34,197,94,0.12);border:1px solid rgba(34,197,94,0.25)}
.bot-avatar.idle{background:rgba(234,179,8,0.12);border:1px solid rgba(234,179,8,0.25)}
.bot-avatar.offline{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2)}
.status-dot{position:absolute;bottom:-2px;right:-2px;width:14px;height:14px;border-radius:50%;border:3px solid var(--card)}
.status-dot.online{background:var(--green);box-shadow:0 0 6px var(--green)}
.status-dot.idle{background:var(--yellow);box-shadow:0 0 6px var(--yellow)}
.status-dot.offline{background:var(--red);box-shadow:0 0 6px var(--red)}
.desk-actions{font-size:11px;color:var(--text-dim);background:rgba(255,255,255,0.05);padding:3px 8px;border-radius:6px}
.bot-name{font-size:14px;font-weight:600;margin-bottom:4px}
.bot-desc{font-size:12px;color:var(--text-dim);line-height:1.4}
.bot-meta{display:flex;align-items:center;gap:8px;margin-top:12px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.05)}
.bot-status-text{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
.bot-status-text.online{color:var(--green)}
.bot-status-text.idle{color:var(--yellow)}
.bot-status-text.offline{color:var(--red)}
.pulse{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:4px;animation:pulse 2s infinite}
.pulse.online{background:var(--green)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

.overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);z-index:200;opacity:0;pointer-events:none;transition:opacity 0.3s}
.overlay.open{opacity:1;pointer-events:all}
.panel{position:fixed;top:0;right:0;bottom:0;width:420px;max-width:100vw;background:var(--panel-bg);border-left:1px solid var(--border);z-index:201;transform:translateX(100%);transition:transform 0.35s cubic-bezier(0.4,0,0.2,1);overflow-y:auto;display:flex;flex-direction:column}
.panel.open{transform:translateX(0)}
.panel-header{padding:24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:16px;position:sticky;top:0;background:var(--panel-bg);z-index:1}
.panel-close{width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:background 0.2s}
.panel-close:hover{background:var(--card)}
.panel-avatar{width:56px;height:56px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:28px}
.panel-info h2{font-size:18px;font-weight:700}
.panel-info p{font-size:13px;color:var(--text-dim)}
.panel-body{padding:24px;flex:1}
.panel-section{margin-bottom:24px}
.panel-section h3{font-size:12px;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:12px}
.metric-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.metric{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px}
.metric .val{font-size:22px;font-weight:700}
.metric .mlabel{font-size:11px;color:var(--text-dim);margin-top:2px}
.activity-item{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.04)}
.activity-item:last-child{border-bottom:none}
.activity-dot{width:8px;height:8px;border-radius:50%;background:var(--blue);margin-top:5px;flex-shrink:0}
.activity-text{font-size:13px;line-height:1.5}
.activity-time{font-size:11px;color:var(--text-dim)}
.desc-text{font-size:14px;color:var(--text);line-height:1.6;background:var(--card);padding:14px;border-radius:10px;border:1px solid var(--border)}
.dry-run-badge{display:inline-block;padding:3px 10px;border-radius:6px;font-size:11px;font-weight:700;background:rgba(240,136,62,0.2);color:#f0883e;border:1px solid rgba(240,136,62,0.3)}
.last-refresh{font-size:11px;color:var(--text-dim)}

/* Dispo Pipeline Styles */
.pipeline-section{margin-bottom:32px;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;overflow-x:auto}
.pipeline-header{display:flex;align-items:center;gap:12px;margin-bottom:20px}
.pipeline-header h2{font-size:18px;font-weight:700;background:linear-gradient(135deg,var(--green),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.pipeline-header .pipeline-badge{padding:4px 10px;border-radius:6px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;background:rgba(34,197,94,0.15);color:var(--green);border:1px solid rgba(34,197,94,0.3)}
.pipeline-flow{display:flex;align-items:flex-start;gap:8px;min-width:max-content;padding:10px 0}
.pipeline-stage{display:flex;flex-direction:column;align-items:center;gap:6px}
.stage-pill{padding:10px 16px;border-radius:10px;background:var(--card-hover);border:1px solid var(--border);font-size:12px;font-weight:600;text-align:center;min-width:100px;transition:all 0.2s}
.stage-pill.start-marketing{background:rgba(34,197,94,0.15);border-color:rgba(34,197,94,0.4);color:var(--green);box-shadow:0 0 15px rgba(34,197,94,0.2)}
.stage-count{font-size:10px;color:var(--text-dim);background:rgba(255,255,255,0.05);padding:2px 8px;border-radius:4px}
.pipeline-arrow{color:var(--text-dim);font-size:18px;display:flex;align-items:center;padding-top:8px}
.pipeline-split{display:flex;flex-direction:column;gap:12px;position:relative;padding-left:20px}
.pipeline-split::before{content:'';position:absolute;left:0;top:20px;bottom:20px;width:2px;background:var(--border)}
.split-branch{display:flex;align-items:center;gap:8px}
.split-branch::before{content:'';width:16px;height:2px;background:var(--border)}
.branch-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;padding:6px 12px;border-radius:8px;min-width:100px;text-align:center}
.branch-label.hunts{background:rgba(59,130,246,0.15);color:var(--blue);border:1px solid rgba(59,130,246,0.3)}
.branch-label.lists{background:rgba(168,85,247,0.15);color:var(--purple);border:1px solid rgba(168,85,247,0.3)}
.branch-channels{display:flex;flex-wrap:wrap;gap:6px;margin-left:8px}
.channel-tag{font-size:10px;padding:4px 8px;border-radius:4px;background:rgba(255,255,255,0.05);color:var(--text-dim);border:1px solid rgba(255,255,255,0.08)}
.schedule-bar{margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}
.schedule-title{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:10px}
.schedule-days{display:flex;gap:4px;border-radius:8px;overflow:hidden}
.schedule-day{flex:1;padding:10px 12px;text-align:center;font-size:11px;font-weight:600;text-transform:uppercase;transition:all 0.3s}
.schedule-day.exclusive{background:rgba(59,130,246,0.2);color:var(--blue)}
.schedule-day.public{background:rgba(34,197,94,0.2);color:var(--green)}
.schedule-day.inbound{background:rgba(234,179,8,0.2);color:var(--yellow)}
.schedule-day.today{box-shadow:inset 0 0 0 2px currentColor;animation:today-pulse 2s infinite}
@keyframes today-pulse{0%,100%{opacity:1}50%{opacity:0.7}}
.schedule-legend{display:flex;gap:16px;margin-top:10px;flex-wrap:wrap}
.legend-item{display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-dim)}
.legend-dot{width:8px;height:8px;border-radius:2px}
.legend-dot.blue{background:var(--blue)}
.legend-dot.green{background:var(--green)}
.legend-dot.yellow{background:var(--yellow)}

@media(max-width:600px){
  .header-inner{flex-direction:column;align-items:flex-start}
  .stats-bar{width:100%;justify-content:space-between}
  .desk-grid{grid-template-columns:1fr 1fr}
  .panel{width:100vw}
  .stat{padding:6px 10px}
  .stat .num{font-size:15px}
}
@media(max-width:400px){
  .desk-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<header class="header">
  <div class="header-inner">
    <div class="logo-area">
      <div class="logo-icon">üéØ</div>
      <div class="logo-text">
        <h1>Gunner Control Room</h1>
        <p>AI Workforce Dashboard</p>
      </div>
    </div>
    <div class="header-right">
      <div class="connection-badge disconnected" id="conn-badge">üî¥ Connecting‚Ä¶</div>
      <span class="last-refresh" id="last-refresh"></span>
      <div class="stats-bar">
        <div class="stat"><div class="dot green"></div><div><div class="num" id="cnt-online">0</div><div class="label">Online</div></div></div>
        <div class="stat"><div class="dot yellow"></div><div><div class="num" id="cnt-idle">0</div><div class="label">Standby</div></div></div>
        <div class="stat"><div class="dot red"></div><div><div class="num" id="cnt-offline">0</div><div class="label">Planned</div></div></div>
        <div class="stat"><div><div class="num" id="cnt-total">0</div><div class="label">Total Bots</div></div></div>
      </div>
    </div>
  </div>
</header>

<div class="overlay" id="overlay" onclick="closePanel()"></div>
<div class="panel" id="panel">
  <div class="panel-header">
    <button class="panel-close" onclick="closePanel()">‚úï</button>
    <div class="panel-avatar" id="p-avatar"></div>
    <div class="panel-info"><h2 id="p-name"></h2><p id="p-engine"></p></div>
  </div>
  <div class="panel-body">
    <div class="panel-section">
      <h3>Description</h3>
      <div class="desc-text" id="p-desc"></div>
    </div>
    <div class="panel-section">
      <h3>Live Metrics</h3>
      <div class="metric-grid" id="p-metrics"></div>
    </div>
    <div class="panel-section">
      <h3>Recent Activity <span class="dry-run-badge" id="p-dryrun" style="display:none">DRY RUN</span></h3>
      <div id="p-activity"></div>
    </div>
  </div>
</div>

<main class="main">
  <!-- Dispo Pipeline Section -->
  <section class="pipeline-section" id="dispo-pipeline">
    <div class="pipeline-header">
      <h2>üöÄ Dispo Pipeline</h2>
      <span class="pipeline-badge">LIVE</span>
    </div>
    <div class="pipeline-flow">
      <div class="pipeline-stage">
        <div class="stage-pill">üìã Expectations Set</div>
        <div class="stage-count" id="stage-expectations">‚Äî deals</div>
      </div>
      <div class="pipeline-arrow">‚Üí</div>
      <div class="pipeline-stage">
        <div class="stage-pill">üì∏ Photos</div>
        <div class="stage-count" id="stage-photos">‚Äî deals</div>
      </div>
      <div class="pipeline-arrow">‚Üí</div>
      <div class="pipeline-stage">
        <div class="stage-pill">üìä Details & Numbers</div>
        <div class="stage-count" id="stage-details">‚Äî deals</div>
      </div>
      <div class="pipeline-arrow">‚Üí</div>
      <div class="pipeline-stage">
        <div class="stage-pill">üåê Property Website</div>
        <div class="stage-count" id="stage-website">‚Äî deals</div>
      </div>
      <div class="pipeline-arrow">‚Üí</div>
      <div class="pipeline-stage">
        <div class="stage-pill start-marketing">üö¶ START MARKETING</div>
        <div class="stage-count" id="stage-marketing">‚Äî ready</div>
      </div>
      <div class="pipeline-arrow">‚Üí</div>
      <div class="pipeline-split">
        <div class="split-branch">
          <div class="branch-label hunts">üéØ Buyer Hunts</div>
          <div class="branch-channels">
            <span class="channel-tag">InvestorLift</span>
            <span class="channel-tag">Mevlo</span>
            <span class="channel-tag">Zillow</span>
            <span class="channel-tag">MLS</span>
            <span class="channel-tag">Facebook</span>
            <span class="channel-tag">Mass Campaigns</span>
          </div>
        </div>
        <div class="split-branch">
          <div class="branch-label lists">üìã Buyer Lists</div>
          <div class="branch-channels">
            <span class="channel-tag">Privy</span>
            <span class="channel-tag">OpenDeal</span>
            <span class="channel-tag">JV Partners</span>
          </div>
        </div>
      </div>
    </div>
    <div class="schedule-bar">
      <div class="schedule-title">Weekly Dispo Schedule</div>
      <div class="schedule-days" id="schedule-days">
        <div class="schedule-day exclusive" data-day="1">Mon<br><small>Exclusive</small></div>
        <div class="schedule-day exclusive" data-day="2">Tue<br><small>Exclusive</small></div>
        <div class="schedule-day public" data-day="3">Wed<br><small>Public Blast</small></div>
        <div class="schedule-day inbound" data-day="4">Thu<br><small>Inbound + Hunts</small></div>
        <div class="schedule-day inbound" data-day="5">Fri<br><small>Inbound + Hunts</small></div>
      </div>
      <div class="schedule-legend">
        <div class="legend-item"><div class="legend-dot blue"></div>Mon-Tue: Exclusive buyer list push</div>
        <div class="legend-item"><div class="legend-dot green"></div>Wed: Public blast everywhere</div>
        <div class="legend-item"><div class="legend-dot yellow"></div>Thu-Fri: Inbound + buyer hunts</div>
      </div>
    </div>
  </section>
  <!-- Engine Grids -->
  <div id="engines-container"></div>
</main>

<script>
const API = 'https://gunner-engine-production.up.railway.app';

// Static bot definitions (layout + descriptions). Real status comes from API.
// engineKey maps to ENGINE_<KEY>=active env vars on Railway
const engineLayout = [
  {id:'data-hygiene',name:'Data Hygiene',apiId:'data-hygiene',engineKey:'data_hygiene',bots:[
    {name:'Data Cleaner',icon:'üßπ',desc:'Validates phone numbers, emails, normalizes names (ALL CAPS ‚Üí Title Case), standardizes addresses. Flags invalid data for review.'},
    {name:'Data Enrichment',icon:'üîç',desc:'Detects missing fields, standardizes PPL source tags (leadzolo/propertyleads/motivatedsellers), fixes attribution source for Lead IQ scoring.'},
    {name:'Duplicate Detector',icon:'üîÄ',desc:'Finds contacts sharing the same phone or address. Flags for manual review ‚Äî never auto-merges.'},
    {name:'Quality Scorer',icon:'üìä',desc:'Scores every contact 0-100 on data completeness. Tags as good/needs-review/poor. Flags untouched leads with zero activity.'}
  ]},
  {id:'lead-iq',name:'Lead Intelligence',apiId:'lead-iq',engineKey:'lead_iq',bots:[
    {name:'Lead IQ Scorer',icon:'üß†',desc:'Scores and qualifies every new lead in real-time. Analyzes source, motivation, timeline, condition, and price factors to assign HOT/WARM ratings.'},
    {name:'Lead Watchdog',icon:'üêï',desc:'Monitors new lead SLA ‚Äî flags untouched leads at 15 min, escalates at 30 min. Ensures no PPL lead ($125-150) gets missed.'},
    {name:'New Lead Responder',icon:'‚ö°',desc:'Instant after-hours response. Fires SMS immediately when leads come in outside business hours, queues call task for next business day 9 AM.'}
  ]},
  {id:'crm-scanner',name:'CRM Scanner',apiId:'crm-scanner',engineKey:'crm_scanner',bots:[
    {name:'Pipeline Signals',icon:'üì°',desc:'14 detection rules across 3 tiers (Missed/At Risk/Worth a Look). Scans pipeline health hourly, catches deals falling through cracks.'},
    {name:'Unread Alert Monitor',icon:'üì¨',desc:'Flags team members with 3+ unread conversations. Prevents leads from going cold while sitting in inbox.'},
    {name:'Ghosted Lead Detector',icon:'üëª',desc:'Identifies leads with 4+ outbound attempts and 0 inbound replies over 10+ days. Separates truly ghosted from just slow.'},
    {name:'Walkthrough SLA',icon:'üèÉ',desc:'Monitors time between appointment set and walkthrough completion. Flags delays that could lose motivated sellers.'}
  ]},
  {id:'nurture',name:'Nurture & Timing',apiId:'nurture',engineKey:'nurture',bots:[
    {name:'Follow Up Bot',icon:'üîÑ',desc:'Full lifecycle replacement for GHL follow-up workflows. Auto-discovers dispositions from activity, manages 1-month/4-month/1-year nurture cycles.'},
    {name:'Workflow Shadow',icon:'üîÆ',desc:'Shadows all 3 GHL workflows (1 Month, 4 Month, 1 Year) in parallel with A/B SMS template rotation. Ready to replace when DRY_RUN flips.'},
    {name:'After-Hours Bot',icon:'üåô',desc:'Engages inbound leads during off-hours with intelligent responses. Qualifies and schedules callbacks for the team.'},
    {name:'Seller Re-engagement',icon:'üîÅ',desc:'Re-engages declined sellers with timed follow-ups. Monitors for signals that seller motivation may have changed.'},
    {name:'Appointment Bot',icon:'üìÖ',desc:'Catches no-shows, sends confirmations, manages reschedules. Integrates with team calendars for real-time availability.'}
  ]},
  {id:'scheduling',name:'Scheduling',apiId:'scheduling',engineKey:'scheduling',bots:[
    {name:'Scheduling Coordinator',icon:'üóìÔ∏è',desc:'Manages AM availability, prevents double-booking, detects calendar mismatches between GHL and team schedules.'},
    {name:'Callback Capture Bot',icon:'üì≤',desc:'Monitors voicemails and missed calls for callback requests. Auto-creates call tasks assigned to the right team member.'},
    {name:'Cancellation Handler',icon:'üö´',desc:'Detects appointment cancellations and immediately re-engages the lead with reschedule options before they go cold.'}
  ]},
  {id:'deals',name:'Documents & Deals',apiId:'deals',engineKey:'deals',bots:[
    {name:'Contract Bot',icon:'üìù',desc:'Monitors Under Contract stage ‚Äî detected 17+ active contracts. Tracks signature status, deadlines, and closing timeline.'},
    {name:'Deal Packaging Bot',icon:'üì¶',desc:'Scores deal completeness (photos, ARV, repairs, comps). Auto-generates PDF + email template when ready. Signals "ready to market" for buyer distribution.'},
    {name:'Deal Distribution Bot',icon:'üöÄ',desc:'Tier-based buyer matching (verified funding, purchase history, buybox fit). Tier 1 gets 2-hour head start before wider blast.'}
  ]},
  {id:'dispo-lead-gen',name:'Dispo Lead Gen',apiId:'buyer-lead-gen',engineKey:'buyer_leadgen',bots:[
    {name:'Deal Packager',icon:'üì¶',desc:'Scores completeness, auto-generates PDF + email template when deal is ready. Signals "ready to market" for distribution.'},
    {name:'Schedule Engine',icon:'üìÖ',desc:'Weekly cadence: Mon/Tue exclusive buyer push, Wed public blast, Thu/Fri inbound + hunts. Express lane for urgent deals.'},
    {name:'Platform Distributor',icon:'üöÄ',desc:'Pushes deals to InvestorLift, Mevlo, Facebook when schedule permits. Tracks views and responses per platform.'},
    {name:'FAQ Auto-Responder',icon:'üí¨',desc:'Auto-answers buyer questions (ARV, repairs, access, price) from deal data. Escalates negotiation to Dispo Mgnr.'},
    {name:'Buyer Hunt Support',icon:'üéØ',desc:'Generates outreach lists for listing agents near deal. Pre-writes scripts, tracks contacts across deals.'},
    {name:'48-Hour Clock',icon:'‚è∞',desc:'Tracks marketing start, escalates at 12h/24h/36h/48h if no buyer interest.'},
    {name:'Response Tracker',icon:'üìä',desc:'Scores buyer quality, source attribution, auto-manages buyer pipeline stages.'}
  ]},
  {id:'reporting',name:'Data & Reporting',apiId:'reporting',engineKey:'reporting',bots:[
    {name:'KPI Entry Bot',icon:'üìä',desc:'Calculates real KPIs from GHL data ‚Äî leads, appointments, offers, contracts. Ready to push to spreadsheet when Google Sheets access is granted.'},
    {name:'Report Generator',icon:'üìà',desc:'Daily reports at 6pm, weekly Monday 8am, monthly 1st of month. Performance insights, pipeline health, team metrics.'},
    {name:'Team Digest',icon:'üí¨',desc:'Hourly team activity digest ‚Äî who\'s active, call volumes, conversation counts. Surfaces team performance patterns.'}
  ]},
  {id:'voicemail',name:'Voicemail Processing',apiId:'voicemail',engineKey:'voicemail',bots:[
    {name:'Voicemail Bot',icon:'üé§',desc:'CallRail integration ‚Äî polls every 30 min, matches voicemails to GHL contacts, classifies urgency, routes to right team member.'}
  ]},
  {id:'signals',name:'Pipeline Intelligence',apiId:'signals-v2',engineKey:'signals',bots:[
    {name:'Signals V2 Deep Scan',icon:'üî¨',desc:'Every 4 hours ‚Äî comprehensive pipeline analysis. Detects competitor mentions, stall tactics, pricing disconnects, and hidden opportunities across all conversations.'}
  ]},
  {id:'standalone',name:'Planned / External',apiId:null,engineKey:null,bots:[
    {name:'PPL Refund Bot',icon:'üí∞',desc:'Files lead disputes on PropertyLeads and MotivatedSellers. Needs Playwright automation (no API). Two disputes filed so far ($300 potential refunds).'},
    {name:'Market Watch Bot',icon:'üîç',desc:'Tracks market trends, comparable sales, and pricing shifts. Daily market intelligence for acquisition decisions.'},
    {name:'MLS Monitor Bot',icon:'üè†',desc:'Monitors MLS for pipeline properties that get listed. Alerts team when a deal property shows up on market.'}
  ]}
];

let engineData = {};   // keyed by apiId
let allLogs = [];
let connected = false;
let dryRunMode = false;
let engineStatuses = {};

function timeAgo(ts) {
  if (!ts) return '‚Äî';
  const diff = (Date.now() - new Date(ts).getTime()) / 1000;
  if (diff < 60) return Math.round(diff) + 's ago';
  if (diff < 3600) return Math.round(diff / 60) + 'm ago';
  if (diff < 86400) return Math.round(diff / 3600) + 'h ago';
  return Math.round(diff / 86400) + 'd ago';
}

async function fetchData() {
  try {
    const [statusRes, enginesRes, logsRes] = await Promise.all([
      fetch(API + '/api/status'),
      fetch(API + '/api/engines'),
      fetch(API + '/api/logs/recent?limit=50')
    ]);
    if (!statusRes.ok || !enginesRes.ok) throw new Error('API error');

    const status = await statusRes.json();
    const engData = await enginesRes.json();
    allLogs = await logsRes.json();
    dryRunMode = status.dryRun;
    engineStatuses = status.engineStatuses || {};

    // Index engine data by id
    engineData = {};
    (engData.engines || []).forEach(e => { engineData[e.id] = e; });

    connected = true;
    updateConnectionBadge();
    render();
  } catch (err) {
    console.error('Failed to fetch engine data:', err);
    connected = false;
    updateConnectionBadge();
    render();
  }
}

function updateConnectionBadge() {
  const badge = document.getElementById('conn-badge');
  if (connected) {
    badge.className = 'connection-badge connected';
    badge.textContent = 'üü¢ Connected to Engine';
  } else {
    badge.className = 'connection-badge disconnected';
    badge.textContent = 'üî¥ Disconnected';
  }
  document.getElementById('last-refresh').textContent = 'Updated ' + new Date().toLocaleTimeString();
}

function getEngineStatus(apiId, engineKey) {
  if (!connected || !apiId) return 'offline';
  // Per-engine activation check ‚Äî if engine is in dry-run, show as dry-run regardless of log activity
  if (engineKey && engineStatuses[engineKey] === 'dry-run') return 'dry-run';
  if (engineKey && engineStatuses[engineKey] === 'active') {
    const e = engineData[apiId];
    if (e && e.status === 'online') return 'online';
    return 'standby'; // active but no recent activity
  }
  const e = engineData[apiId];
  return e ? e.status : 'offline';
}

function getBotStatus(engineApiId, engineKey) {
  return getEngineStatus(engineApiId, engineKey);
}

function getEngineLogs(apiId) {
  if (!apiId || !engineData[apiId]) return [];
  return (engineData[apiId].recentLogs || []);
}

function highlightTodaySchedule() {
  const today = new Date().getDay(); // 0=Sun, 1=Mon, ..., 5=Fri, 6=Sat
  document.querySelectorAll('.schedule-day').forEach(day => {
    day.classList.remove('today');
    if (parseInt(day.dataset.day) === today) {
      day.classList.add('today');
    }
  });
}

function render() {
  const main = document.getElementById('engines-container');
  main.innerHTML = '';
  highlightTodaySchedule();
  let totalOnline = 0, totalIdle = 0, totalOffline = 0;

  engineLayout.forEach(eng => {
    const section = document.createElement('div');
    section.className = 'engine';
    const engStatus = getEngineStatus(eng.apiId, eng.engineKey);
    const statusLabel = engStatus === 'dry-run' ? 'DRY RUN' : connected && engStatus === 'online' ? 'LIVE' : connected && (engStatus === 'idle' || engStatus === 'standby') ? 'STANDBY' : 'OFFLINE';
    const badgeClass = engStatus === 'dry-run' ? 'dryrun' : engStatus === 'online' ? 'online' : (engStatus === 'idle' || engStatus === 'standby') ? 'idle' : 'offline';
    const engInfo = engineData[eng.apiId];
    const lastScan = engInfo ? timeAgo(engInfo.lastRunTime) : '‚Äî';
    const actionCount = engInfo ? (engInfo.actionCount || 0) : 0;
    const statusDesc = engInfo ? (engInfo.statusDescription || '') : '';

    section.innerHTML = `<div class="engine-header">
      <span class="engine-badge ${badgeClass}">${statusLabel}</span>
      <span class="engine-title">${eng.name}</span>
      <span class="engine-subtitle">${eng.bots.length} bot${eng.bots.length > 1 ? 's' : ''} ¬∑ ${actionCount} action${actionCount !== 1 ? 's' : ''} today ¬∑ ${statusDesc}</span>
    </div><div class="desk-grid" id="grid-${eng.id}"></div>`;
    main.appendChild(section);
    const grid = document.getElementById('grid-' + eng.id);

    eng.bots.forEach(bot => {
      const botStatus = getBotStatus(eng.apiId, eng.engineKey);
      if (botStatus === 'online') totalOnline++;
      else if (botStatus === 'idle' || botStatus === 'standby') totalIdle++;
      else totalOffline++; // dry-run and offline both count as offline

      const card = document.createElement('div');
      card.className = `desk status-${botStatus}`;
      const engInfo = engineData[eng.apiId];
      const engLogs = getEngineLogs(eng.apiId);
      const lastActionTime = engInfo && engInfo.lastActionTime ? timeAgo(engInfo.lastActionTime) : (engLogs[0] ? timeAgo(engLogs[0].timestamp) : '‚Äî');
      const lastActionText = engInfo && engInfo.lastAction ? engInfo.lastAction : '';
      const actionCount = engInfo ? (engInfo.actionCount || 0) : 0;
      const statusText = botStatus === 'dry-run' ? '<span style="color:var(--yellow)">‚óè DRY RUN</span>' : botStatus === 'online' ? '<span class="pulse online"></span>Online' : (botStatus === 'idle' || botStatus === 'standby') ? 'Standby' : 'Offline';

      // Show last action, or monitoring message, or description
      let cardDesc;
      if (lastActionText) {
        cardDesc = lastActionText.substring(0, 70) + (lastActionText.length > 70 ? '‚Ä¶' : '');
      } else if (botStatus === 'dry-run') {
        cardDesc = 'Logging only ‚Äî not taking actions';
      } else if (botStatus === 'online' || botStatus === 'idle' || botStatus === 'standby') {
        cardDesc = 'Active ‚Äî waiting for triggers';
      } else {
        cardDesc = bot.desc.substring(0, 60) + '‚Ä¶';
      }

      const actionBadge = actionCount > 0 ? `${actionCount} action${actionCount !== 1 ? 's' : ''}` : lastActionTime;

      card.innerHTML = `<div class="desk-top">
        <div class="bot-avatar ${botStatus}">${bot.icon}<div class="status-dot ${botStatus}"></div></div>
        <div class="desk-actions">${actionBadge}</div>
      </div>
      <div class="bot-name">${bot.name}</div>
      <div class="bot-desc">${cardDesc}</div>
      <div class="bot-meta">
        <span class="bot-status-text ${botStatus}">${statusText}</span>
      </div>`;
      card.onclick = () => openPanel(bot, eng);
      grid.appendChild(card);
    });
  });

  document.getElementById('cnt-online').textContent = totalOnline;
  document.getElementById('cnt-idle').textContent = totalIdle;
  document.getElementById('cnt-offline').textContent = totalOffline;
  document.getElementById('cnt-total').textContent = totalOnline + totalIdle + totalOffline;
}

function openPanel(bot, eng) {
  const botStatus = getBotStatus(eng.apiId, eng.engineKey);
  document.getElementById('p-avatar').className = 'panel-avatar bot-avatar ' + botStatus;
  document.getElementById('p-avatar').innerHTML = bot.icon;
  document.getElementById('p-name').textContent = bot.name;
  document.getElementById('p-engine').textContent = eng.name;
  document.getElementById('p-desc').textContent = bot.desc;

  // Dry run badge ‚Äî per-engine awareness
  const dryBadge = document.getElementById('p-dryrun');
  const engineIsActive = botStatus === 'online' || botStatus === 'idle' || botStatus === 'standby';
  if (engineIsActive) {
    dryBadge.style.display = 'inline-block';
    dryBadge.textContent = 'ACTIVE';
    dryBadge.style.background = 'var(--green)';
    dryBadge.style.color = '#000';
  } else if (dryRunMode) {
    dryBadge.style.display = 'inline-block';
    dryBadge.textContent = 'DRY RUN';
    dryBadge.style.background = '';
    dryBadge.style.color = '';
  } else {
    dryBadge.style.display = 'none';
  }

  // Metrics from real data
  const engInfo = engineData[eng.apiId];
  const mg = document.getElementById('p-metrics');
  mg.innerHTML = '';
  if (engInfo) {
    const metrics = [
      { v: engInfo.actionCount || 0, l: 'Actions Today' },
      { v: botStatus === 'online' ? 'üü¢' : (botStatus === 'idle' || botStatus === 'standby') ? 'üü°' : botStatus === 'dry-run' ? 'üü†' : 'üî¥', l: 'Status' },
      { v: engInfo.lastActionTime ? timeAgo(engInfo.lastActionTime) : '‚Äî', l: 'Last Action' },
      { v: botStatus === 'dry-run' ? 'DRY RUN' : engineIsActive ? 'ACTIVE' : 'OFFLINE', l: 'Mode' }
    ];
    metrics.forEach(m => {
      mg.innerHTML += `<div class="metric"><div class="val">${m.v}</div><div class="mlabel">${m.l}</div></div>`;
    });
  } else {
    mg.innerHTML = '<div class="metric"><div class="val">‚Äî</div><div class="mlabel">No data</div></div>';
  }

  // Activity from real logs
  const ag = document.getElementById('p-activity');
  ag.innerHTML = '';
  const logs = getEngineLogs(eng.apiId);
  if (logs.length === 0) {
    ag.innerHTML = '<div style="color:var(--text-dim);font-size:13px;padding:12px 0;">No recent activity from this engine.</div>';
  } else {
    logs.forEach(l => {
      ag.innerHTML += `<div class="activity-item"><div class="activity-dot"></div><div><div class="activity-text">${l.description || l.operation}</div><div class="activity-time">${timeAgo(l.timestamp)}</div></div></div>`;
    });
  }

  document.getElementById('overlay').classList.add('open');
  document.getElementById('panel').classList.add('open');
}

function closePanel() {
  document.getElementById('overlay').classList.remove('open');
  document.getElementById('panel').classList.remove('open');
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closePanel(); });

// Initial load + auto-refresh every 30s
fetchData();
setInterval(fetchData, 30000);
</script>
</body>
</html>
